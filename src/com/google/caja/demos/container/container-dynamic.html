<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<!--
 - Copyright (C) 2010 Google Inc.
 -
 - Licensed under the Apache License, Version 2.0 (the "License");
 - you may not use this file except in compliance with the License.
 - You may obtain a copy of the License at
 -
 -      http://www.apache.org/licenses/LICENSE-2.0
 -
 - Unless required by applicable law or agreed to in writing, software
 - distributed under the License is distributed on an "AS IS" BASIS,
 - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 - See the License for the specific language governing permissions and
 - limitations under the License.
-->

<html>
  <head>
    <!-- Pick your cajoling and library server here: -->
    <base href="http://caja.appspot.com/"> <!-- public test server -->
    <!-- <base href="http://localhost:8080/"> - 'ant runserver' locally -->
    
    <meta name="keywords" content="caja, trivial container, safe, javascript,
        object capabilities">
    <meta name="description" content="Demo trivial container">
    <meta http-equiv="content-language" content="en">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="author" content="Jasvir Nagra (jasvir@gmail.com)">
    <meta name="distribution" content="Global">
    <meta name="copyright" content="Apache Public License">
    <meta name="robots" content="follow,index">

    <title>Dynamic-Loading Caja Container</title>
    
    <script type="text/javascript" src="domita-minified.js"></script>
    <script type="text/javascript" src="log-to-console.js" ></script>
    <script type="text/javascript" src="setup-valija.js"   ></script>
    <script type="text/javascript" src="valija.out.js"     ></script>
    <script type="text/javascript" src="uri.js"            ></script>
    <script type="text/javascript" src="cajita-promise.js" ></script>
    <script type="text/javascript" src="cajita-module.js"  ></script>
  </head>

  <body>
    <div id="container"></div>
    <script type="text/javascript">
      function makeGadgetEnvironment(container) {
        var imports = ___.copy(___.sharedImports);
        imports.outers = imports;
        
        // Create Domita (DOM taming, virtualized document) instance.
        //
        // attachDocumentStub is from domita-minified.js.
        attachDocumentStub('-' + container.className, {
            rewrite: function() {
                return null;
            }
        }, imports, container);
        
        // Create HTML-emitter for gadget's HTML and document.write -- this
        // should be done *after* Domita setup so that imports.document exists.
        //
        // HtmlEmitter is from domita-minified.js.
        imports.htmlEmitter___ = new HtmlEmitter(container, imports.document);

        // Create Valija (unrestricted-JavaScript emulation environment)
        // instance.
        //
        // valijaMaker is defined in valija.out.js, but setup-valija.js
        // arranges for it to be exported as a global function. Since 
        // valija.out.js is cajoled code, functions in it must be invoked in
        // this way.
        imports.$v = valijaMaker.CALL___(imports.outers);

        return imports;
      }

      function loadGadget(pluginName, url) {
          var containerDiv = document.createElement('div');
          containerDiv.className = pluginName + "-form___";
          document.getElementById("container").appendChild(containerDiv);
          var imports = makeGadgetEnvironment(containerDiv);
          
          var load = scriptModuleLoadMaker(document.location.toString());
          Q.when(load.async(url), function(moduleFunc) {
            moduleFunc(imports);
          });
      }
    </script>

    <script>
      loadGadget("gadget1", 'http://www.thinkfu.com/trivial.html');
    </script>
    <script>
      loadGadget("gadget2", 'http://www.thinkfu.com/trivial.html');
    </script>
</body> 
</html> 