<!--
 - Copyright (C) 2011 Google Inc.
 -
 - Licensed under the Apache License, Version 2.0 (the "License");
 - you may not use this file except in compliance with the License.
 - You may obtain a copy of the License at
 -
 -      http://www.apache.org/licenses/LICENSE-2.0
 -
 - Unless required by applicable law or agreed to in writing, software
 - distributed under the License is distributed on an "AS IS" BASIS,
 - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 - See the License for the specific language governing permissions and
 - limitations under the License.
-->

<div class="clickme testcontainer" id="testEventBubble">
  testEventBubble
  <input type="checkbox">
</div>
<script type="text/javascript">
  jsunitRegister('testEventBubble', function testEventBubble() {
    function listener(e) {
      if (e.currentTarget.id === 'testEventBubble') {
        pass('testEventBubble');
      } else {
        fail('testEventBubble');
      }
    }
    var parent = document.getElementById('testEventBubble');
    parent.addEventListener('change', listener, false);
  });
</script>

<p class="clickme testcontainer" id="testExceptionInEventHandler">
  <span onclick="die();">
    click me.  Exceptions in event handlers should invoke onerror.
  </span>
</p>
<script type="text/javascript">
  window.onerror = (function (onerror) {
    return function (message, url, line) {
        assertEquals('died!', message);
        pass('testExceptionInEventHandler');
        window.onerror = onerror;
      };
  })(onerror);
  window.die = function die() {
    throw new Error('died!');
  };
  jsunitRegister('testExceptionInEventHandler',
                 function testExceptionInEventHandler() { });
</script>

<p class="clickme testcontainer" id="testFunctionCallsInAttributes">
  <span onclick="doIt(event, this);">
    click me.  Function calls in attributes should work.
  </span>
</p>
<script type="text/javascript">
  window.doIt = function doIt(event, node) {
    if ((event instanceof Event) && (node instanceof HTMLElement)) {
      pass('testFunctionCallsInAttributes');
    } else {
      console.error('testFunctionCallsInAttributes: wrong args event=', event,
          'node=', node);
    }
  };
  jsunitRegister('testFunctionCallsInAttributes',
                 function testFunctionCallsInAttributes() { });
</script>

<p class="clickme testcontainer" id="testCodeInAttributes">
  <span onclick="if (true) pass('testCodeInAttributes');">
    click me.  Nontrivial code in attributes should work.
  </span>
</p>
<script type="text/javascript">
  jsunitRegister('testCodeInAttributes',
                 function testCodeInAttributes() { });
</script>

<p class="manual testcontainer" id="testRelatedTarget-mouse-container">
  <span id="testRelatedTarget-mouse">
    Move mouse here to see event.relatedTarget.
    Rapid motion from outside sandbox should show a null relatedTarget.
  </span>
  <br />
  <span id="testRelatedTarget-mouse-info">&nbsp;</span>
</p>
<p class="clickme testcontainer" id="testRelatedTarget">
  <b id="testRelatedTarget-child">click me (testRelatedTarget)
  </b>
</p>
<script type="text/javascript">
  jsunitRegister('testRelatedTarget',
                 function testRelatedTarget() {
    var childClick = jsunitCallback(function (event) {
      // get should work.  in manual clicks, relatedTarget is null, but in
      // webdriver simulated clicks, it's non-null.
      assertEquals(event.relatedTarget, event.relatedTarget);
      // set doesn't have to work, but shouldn't throw an error
      event.relatedTarget = [];
      pass('testRelatedTarget');
    });

    var child = document.getElementById('testRelatedTarget-child');
    child.addEventListener('click', childClick, false);

    // TODO: webdriver doesn't have a good way of testing relatedTarget.
    // there are two cases we care about: relatedTarget is an element in the
    // sandbox, and relatedTarget is an element outside the sandbox.

    var mouseReport = jsunitCallback(function (event) {
      var r = event.relatedTarget;
      r = r && (r.tagName + '#' + r.id);
      info.innerHTML = event.type + ' ' + String(r);
    });

    var mouse = document.getElementById('testRelatedTarget-mouse');
    var info = document.getElementById('testRelatedTarget-mouse-info');
    mouse.addEventListener('mouseover', mouseReport, false);
    mouse.addEventListener('mouseout', mouseReport, false);
  });
</script>

<p class="clickme testcontainer" id="testListenerArguments">
  <b id="testListenerArguments-label">click me: testListenerArguments</b>
</p>
<script type="text/javascript">
  jsunitRegister('testListenerArguments',
                 function testListenerArguments() {
    var container = document.getElementById('testListenerArguments-label');
    container.addEventListener(
        'click',
        jsunitCallback(
            function eventListener(event) {
              assertEquals(1, arguments.length);
              assertEquals('click', event.type);
              pass('testListenerArguments');
            }));
  });
</script>

<p class="clickme testcontainer" id="testHandlerArguments">
  <b id="testHandlerArguments-label">click me: testHandlerArguments</b>
</p>
<script type="text/javascript">
  jsunitRegister('testHandlerArguments',
                 function testHandlerArguments() {
    var container = document.getElementById('testHandlerArguments-label');
    container.onclick = jsunitCallback(
        function eventListener(event) {
          assertEquals(1, arguments.length);
          assertEquals('click', event.type);
          pass('testHandlerArguments');
        });
  });
</script>

<p class="clickme testcontainer" id="testAddEventListener">
  <b id="testAddEventListener-label">click me</b>
</p>
<script type="text/javascript">
  jsunitRegister('testAddEventListener',
                 function testAddEventListener() {
    var container = document.getElementById('testAddEventListener-label');
    container.addEventListener(
        'click',
        jsunitCallback(
            function eventListener(event) {
              console.log('received event');
              assertEquals('B', event.target.tagName);
              assertEquals('click', event.type);
              pass('testAddEventListener');
            }));
    expectFailure(
        function() {
          container.addEventListener('foo');
        },
        'addEventListener of a string');
    expectFailure(
        function() {
          container.addEventListener({});
        },
        'addEventListener of an ordinary object');
  });
</script>

<p class="testcontainer" id="testDocumentDomContentLoaded">
  Waiting for DOMContentLoaded.
</p>
<script type="text/javascript">
  jsunitRegister('testDocumentDomContentLoaded',
                 function testDocumentDomContentLoaded() {
    document.addEventListener(
        'DOMContentLoaded',
        jsunitCallback(
            function eventListener(event) {
              assertEquals('DOMContentLoaded', event.type);
              assertEquals(1, arguments.length);
              pass('testDocumentDomContentLoaded');
            }));
  });
</script>

<p class="clickme testcontainer" id="testRemoveEventListener">
  <b id="testRemoveEventListener-label">click me</b>
</p>
<script type="text/javascript">
  jsunitRegister('testRemoveEventListener',
                 function testRemoveEventListener() {
    var container = document.getElementById('testRemoveEventListener-label');
    var firstFired = false;
    var failed = false;
    var second = jsunitCallback(
        function secondcb(event) {
          console.log('received event');
          if (failed) { return; }
          assertEquals('B', event.target.tagName);
          assertEquals('click', event.type);
          event.target.innerHTML = 'All done!';
          pass('testRemoveEventListener');
        });
    var first = jsunitCallback(
        function firstcb(event) {
          if (firstFired) {
            event.target.innerHTML =
                '<b>FAILED - event handler was not removed!</b>';
            failed = true;
            return;
          }
          firstFired = true;
          console.log('received event');
          assertEquals('B', event.target.tagName);
          assertEquals('click', event.type);
          event.target.innerHTML = 'Thank you, click me again please';
          container.removeEventListener('click', first);
          container.addEventListener('click', second);
        });
    container.addEventListener('click', first);
  });
</script>

<p class="clickme testcontainer" id="testRepeatedHandlers">
  <b id="testRepeatedHandlers-label">testRepeatedHandlers - click me
      <span id="testRepeatedHandlers-count"></span> times</b>
</p>
<script type="text/javascript">
  jsunitRegister('testRepeatedHandlers',
                 function testRepeatedHandlers() {
    // an element containing the one being clicked on
    var container = document.getElementById('testRepeatedHandlers');

    // result gathering/scheduling
    var counter = document.getElementById('testRepeatedHandlers-count');
    var hits = [];
    var registeredToProceed = false;
    var listener = jsunitCallback(function listener(event) {
      hits.push([event.type, event.eventPhase]);
      if (!registeredToProceed && event.type === 'mouseup') {
        registeredToProceed = true;
        setTimeout(jsunitCallback(function() {
          registeredToProceed = false;
          fns.shift()();
          counter.textContent = fns.length;
        }), 0);
      }
    });

    container.addEventListener('mousedown', function distraction() {}, true);
    container.addEventListener('mousedown', listener, true);
    container.addEventListener('mousedown', listener, true);  // duplicate noop
    container.addEventListener('mousedown', listener, false);
    container.addEventListener('mousedown', listener, false);  // duplicate noop
    container.addEventListener('mouseup', listener, true);
    container.addEventListener('mouseup', listener, false);

    var fns = [function() {
      // correct ordering, and no duplicates
      assertEquals('first',
          'mousedown,1,mousedown,3,mouseup,1,mouseup,3', String(hits));
      hits = [];
      // This removeEventListener should remove only one of the four listeners,
      // which matches the parameters exactly.
      container.removeEventListener('mousedown', listener, false);
    }, function() {
      assertEquals('second',
          'mousedown,1,mouseup,1,mouseup,3', String(hits));
      hits = [];
      pass('testRepeatedHandlers');
    }];
    counter.textContent = fns.length;
  });
</script>

<p class="waiting testcontainer" id="testTimeoutAndInterval">
  Timeouts and Intervals<br>
</p>
<script type="text/javascript">
  jsunitRegister('testTimeoutAndInterval',
                 function testTimeoutAndInterval() {
    var timeout1Ran = false,
        timeout2Ran = false;
    var timeout1Id = setTimeout(jsunitCallback(
        function to1Id() { timeout1Ran = true; }), 50);
    var timeout2Id = setTimeout(jsunitCallback(
        function to2Id() { timeout2Ran = true; }), 50);
    clearTimeout(timeout1Id);

    var intervalRunIndex = -1;
    var interval1RunCount = 0,
        interval2RunCount = 0;
    var interval1Id = setInterval(jsunitCallback(
        function iv1id() { ++interval1RunCount; }), 50);
    var interval2Id = setInterval(jsunitCallback(
        function iv2id() { ++interval2RunCount; }), 50);

    // Check that null is a noop as a timeout or interval value, and that the
    // return value works with clearTimeout and clearInterval and does not
    // inadvertently clear existing timeouts or intervals.
    clearTimeout(setTimeout(null, 0));
    clearInterval(setInterval(null, 0));

    // Check that clearInterval and clearTimeout ignore null
    // and undefined intervalId's
    clearInterval(null);
    clearInterval(void 0);
    clearInterval('1');
    clearInterval({ intervalId : 1 });
    clearInterval(clearInterval);
    clearInterval(timeout2Id);
    clearTimeout(null);
    clearTimeout(void 0);
    clearTimeout('1');
    clearTimeout({ intervalId : 1 });
    clearTimeout(clearTimeout);
    clearTimeout(interval1Id);

    setTimeout(
        jsunitCallback(function () {
          clearInterval(interval2Id);
          setTimeout(
              jsunitCallback(function () {
                if (!timeout1Ran && timeout2Ran
                    && interval1RunCount > interval2RunCount) {
                  clearInterval(interval1Id);
                  pass('testTimeoutAndInterval');
                }
              }),
              500);
        }),
        200);
  });
</script>

<p class="clickme testcontainer" id="testInnerhtmlOnclick">
  <b>do not click yet</b>
</p>
<script type="text/javascript">
  window.innerhtmlClicked = function() {
    pass('testInnerhtmlOnclick');
  };

  jsunitRegister('testInnerhtmlOnclick',
                 function testInnerhtmlOnclick() {
    var el = document.getElementById('testInnerhtmlOnclick');
    el.innerHTML = '<b onclick="innerhtmlClicked();">Click me to call innerhtmlClicked()</b>';
  });
</script>

<p class="clickme testcontainer" id="testOnclickHandler">
  <b id="testOnclickHandler-label"
     onclick="passTestOnclickHandler();">click me</b>
</p>
<script type="text/javascript">
  window.passTestOnclickHandler = function passTestOnclickHandler() {
    pass('testOnclickHandler');
  };
  jsunitRegister('testOnclickHandler',
                 function testOnclickHandler() {
    // Nothing to do here.  pass call in testOnclickHandler HTML.
  });
</script>

<!--
TODO(felix8a): fix javascript url handling
  es53 fails because IMPORTS___.handlers___ doesn't exist.
  ses fails because the js urls don't get rewritten so execute in the feral context.
<p class="clickme testcontainer" id="test-jsuri">
  <a id="test-jsuri-label" href="javascript:alert(1)+pass('test-jsuri')">click JS URL</a>
</p>
<script type="text/javascript">
  jsunitRegister('testJsUri',
                 function testJsUriHandler() {
    // Nothing to do here.  pass call in test-jsuri HTML.
  });
</script>
-->

<p class="clickme testcontainer" id="testCurrentTarget">
  <b id="testCurrentTarget-child">click me</b>
</p>
<script type="text/javascript">
  jsunitRegister('testCurrentTarget',
                 function testCurrentTarget() {
    var parent = document.getElementById('testCurrentTarget');
    var child = document.getElementById('testCurrentTarget-child');
    var gotChildClick = false;

    var childClick = jsunitCallback(function (event) {
      assertEquals('testCurrentTarget-child', event.currentTarget.id);
      gotChildClick = true;
    });

    var parentClick = jsunitCallback(function (event) {
      assertEquals('testCurrentTarget', event.currentTarget.id);
      assertTrue(gotChildClick);
      pass('testCurrentTarget');
    });

    parent.addEventListener('click', parentClick, false);
    child.addEventListener('click', childClick, false);
  });
</script>

<p class="testcontainer" id="testOnLoadListener">Onload</p>
<script type="text/javascript">
  jsunitRegister('testOnLoadListener',
                 function testOnLoadListener() {
    var b1 = false;
    var b2 = false;
    var b3 = false;
    var setb1 = jsunitCallback(
        function setb1cb() {
          console.log('set onload b1');
          b1 = true;
        });
    var setb2 = jsunitCallback(
        function setb2cb(event) {
          assertEquals('load', event.type);
          assertEquals(1, arguments.length);
          console.log('set onload b2');
          b2 = true;
        });
     var setb3 = jsunitCallback(
         function setb3cb() {
           console.log('set onload b3');
           b3 = true;
         });

    window.addEventListener('load', setb1);
    window.addEventListener('load', setb2);
    window.removeEventListener('load', setb1);
    window.onload = setb3;

    assertAsynchronousRequirement(
        'onload listeners',
        jsunitCallback(
            function checkb1b2b3cb() {
              if (!b1 && b2 && b3) {
                pass('testOnLoadListener');
                return true;
              }
              return false;
            }));

    assertFalse(b1);
    assertFalse(b2);
    assertFalse(b3);
  });
</script>

<p class="testcontainer" id="testDOMContentLoadedListener">DOMContentLoaded</p>
<script>
  jsunitRegister('testDOMContentLoadedListener',
                 function testDOMContentLoadedListener() {
    var b1 = false;
    var b2 = false;
    var b3 = false;
    var setb1 = jsunitCallback(
        function setb1cb() {
          console.log('set dcl b1');
          b1 = true;
        });
    var setb2 = jsunitCallback(
        function setb2cb() {
          console.log('set dcl b2');
          b2 = true;
        });
     var setb3 = jsunitCallback(
         function setb3cb() {
           console.log('set dcl b3');
           b3 = !b2; // DOMContentLoaded must fire before load
         });

    window.addEventListener('DOMContentLoaded', setb1);
    window.addEventListener('load', setb2);
    window.addEventListener('DOMContentLoaded', setb3);
    window.removeEventListener('DOMContentLoaded', setb1);

    assertAsynchronousRequirement(
        'DOMContentLoaded listeners',
        jsunitCallback(
            function checkb1b2b3cb() {
              if (!b1 && b2 && b3) {
                pass('testDOMContentLoadedListener');
                return true;
              }
              return false;
            }));

    assertFalse(b1);
    assertFalse(b2);
    assertFalse(b3);
  });
</script>

<div id="testXhrInstanceProps" class="testcontainer">XHR instance props</div>
<script type="text/javascript">
  jsunitRegister('testXhrInstanceProps',
                 function testXhrInstanceProps() {
    var xhr = new window.XMLHttpRequest();
    xhr.x = 1;
    assertEquals(1, xhr.x);
    pass('testXhrInstanceProps');
  });
</script>

<div id="testXhrToDisallowedUrl" class="testcontainer">
  XHR to disallowed URL
</div>
<script type="text/javascript">
  jsunitRegister('testXhrToDisallowedUrl',
                 function testXhrToDisallowedUrl() {
    var xhr;

    xhr = new window.XMLHttpRequest();
    expectFailure(function() {
        xhr.open('GET', 'badscheme://xhrTest.txt', false);
        xhr.send();
      }, 'xhr to disallowed url');
    pass('testXhrToDisallowedUrl');
  });
</script>

<div id="testXhrSync" class="testcontainer">XHR sync</div>
<script type="text/javascript">
  jsunitRegister('testXhrSync',
                 function testXhrSync() {
    var xhr;

    // Check that response text is available after a synchronous XHR
    xhr = new window.XMLHttpRequest();
    xhr.open('GET', './xhrTest.txt', false);
    console.log('About to do sync xhr.send() - may get preempted');
    xhr.send();
    assertEquals('The quick brown fox', xhr.responseText);

    // Check that a synchronous XHR invokes its callback in ready state 4
    var responseText;
    xhr = new window.XMLHttpRequest();
    // Note we specify test id since we get preempted by xhr.send()
    xhr.onreadystatechange = jsunitCallback(
        function onreadystatechangecb() {
          if (xhr.readyState == 4) { responseText = xhr.responseText; }
        },
        'testXhrSync');
    xhr.open('GET', './xhrTest.txt', false);
    console.log('About to do sync xhr.send() - may get preempted');
    xhr.send();
    assertEquals('The quick brown fox', responseText);

    pass('testXhrSync');
  });
</script>

<div id="testXhrAsync" class="waiting testcontainer">XHR async</div>
<script type="text/javascript">
  jsunitRegister('testXhrAsync',
                 function testXhrAsync() {
    var cont = document.getElementById('testXhrAsync');
    var xhr = new window.XMLHttpRequest();
    xhr.open('GET', './xhrTest.txt', true);
    var asyncFlag = 'PRE';
    xhr.onreadystatechange = jsunitCallback(function(event) {
      assertEquals(xhr, event.target);
      if (event.target.readyState === 4) {
        assertNotEquals(4, asyncFlag);
        asyncFlag = 'DONE';
        assertEquals('The quick brown fox', event.target.responseText);
        pass('testXhrAsync');
      }
      asyncFlag = event.target.readyState;
    });
    xhr.send();
  });
</script>

<p id="testEventMutation" class="clickme testcontainer">testEventMutation
    <span>(Assignment to properties of events)</span></p>
<script type="text/javascript">
  jsunitRegister('testEventMutation',
                 function testEventMutation() {
    document.getElementById('testEventMutation')
        .addEventListener('click', jsunitCallback(function(e) {

      // Tamed properties
      assertTrue('target' in e);  // prevent trivial pass
      for (var p in e) {
        var original = directAccess.getFeralProperty(e, p);
        if (p === 'target') {
          // prevent trivial pass
          assertEquals('object', typeof original);
        }
        var v = {};
        e[p] = v;
        assertEquals(p + ' set #1', v, e[p]);
        e[p] = 'foo';
        assertEquals(p + ' set #2', 'foo', e[p]);
        assertTrue(p + ' host value preserved',
            original === directAccess.getFeralProperty(e, p));
      }

      // Expando property
      e.florb = 44;
      assertEquals(44, e.florb);
      assertTrue('expando not found',
          undefined === directAccess.getFeralProperty(e, 'florb'));

      pass('testEventMutation');
    }), false);
  });
</script>

<p id="testCustomEvents" class="testcontainer">Custom Events<br></p>
<script type="text/javascript">
  jsunitRegister('testCustomEvents',
                 function testCustomEvents() {
    withFailureOnLeakedEvent('howdy', function() {
      assertTrue('createEvent exists', !!document.createEvent);

      // Event dispatch for custom events is synchronous
      var fired = false;
      var eventToSend = undefined;

      var eventTarget = document.getElementById('testCustomEvents');
      eventTarget.addEventListener('howdy', jsunitCallback(function (event) {
        // assertEquals("received correct event", eventToSend, event);
        assertEquals("received correct details", 'hiya', event.details);
        fired = true;
      }), true);

      eventToSend = document.createEvent('HTMLEvents');
      eventToSend.details = 'hiya';
      eventToSend.initEvent('howdy', true, true);
      assertEquals('initEvent correct', 'hiya', eventToSend.details);

      eventTarget.dispatchEvent(eventToSend);
      assertTrue('event did fire', fired);
    });
    pass('testCustomEvents');
  });
</script>

<!--

    TODO(ihab.awad): This is invalid for ES53; look at it and
    see if there's anything useful left.

<p class="testcontainer" id="testThisInEventHandlers"
 ><input type="checkbox" id="testThisInEventHandlers-1" />
</p>
<script type="text/javascript">
  jsunitRegister('testThisInEventHandlers',
                 function testThisInEventHandlers() {
    var inp = document.getElementById('testThisInEventHandlers-1');

    // By declaring f() to be cajita, but supplying it as the 'call'
    // property of the object passed to the event listener, we get
    // access to the value the function is supposed to use for the
    // 'this' keyword, even in cajita.
    var f = jsunitCallback(
        function fcb($dis, event, thisNode) {
          'use strict';
          'use cajita';
          // In an event handler, "this" should be bound to the node.
          assertEquals($dis, thisNode);
          pass('testThisInEventHandlers');
        });
    inp.addEventListener('click', {call: f}, false);
    directAccess.click(inp);
  });
</script>

-->

<p id="testDispatchedNoncustom" class="testcontainer">
  Programmatically dispatched mouse by
  <input id="testDispatchedNoncustom-c" type="checkbox">.dispatchEvent()
</p>
<script type="text/javascript">
  jsunitRegister('testDispatchedNoncustom',
                 function testDispatchedNoncustom() {
    withFailureOnLeakedEvent('click', function() {
       // Event dispatch for custom events is synchronous
      var fired = false;
      var eventToSend = undefined;

      var eventTarget = document.getElementById('testDispatchedNoncustom-c');
      eventTarget.addEventListener('click', jsunitCallback(function (event) {
        // assertEquals("received correct event", eventToSend, event);
        assertEquals("received correct details", 'hiya', event.details);
        fired = true;
      }), true);

      eventToSend = document.createEvent('MouseEvents');
      eventToSend.details = 'hiya';
      eventToSend.initEvent('click', true, true);
      // Should be initMouseEvent, but we don't implement that yet.
      //eventToSend.initMouseEvent('click', true, true, window, 1, 100, 0, 0, 0,
      //    false, false, false, false, 0, null);
      //assertEquals('initEvent correct', 100, eventToSend.screenX);

      assertEquals('check initial state', false, eventTarget.checked);
      eventTarget.dispatchEvent(eventToSend);
      assertTrue('event did fire', fired);
      assertEquals('check final state not changed', false, eventTarget.checked);
    });
    pass('testDispatchedNoncustom');
  });
</script>

<p id="testInitEventSecurity" class="clickme testcontainer"><span>
  testInitEventSecurity -- initEvent cannot be used to mutate host events
</span></p>
<script type="text/javascript">
  jsunitRegister('testInitEventSecurity',
                 function testInitEventSecurity() {
    document.getElementById('testInitEventSecurity')
        .addEventListener('click', jsunitCallback(function(e) {
      // Currently non-custom events have no initEvent method at all, so we
      // try borrowing one.
      var initEvent = e.initEvent ||
          document.createEvent('MouseEvents').initEvent;
      // Browser behavior (Chrome, FF) is that initEvent has no effect after
      // dispatchEvent starts. Spec says initEvent "may only be called" before
      // dispatchEvent <http://www.w3.org/TR/DOM-Level-2-Events/events.html>,
      // but that's awfully vague, hence this test.
      initEvent.call(e, 'clank', false, false);
      assertEquals('click', e.type);
      assertEquals('click', directAccess.getFeralProperty(e, 'type'));
      pass('testInitEventSecurity');
    }), false);
  });
</script>

<script type="text/javascript">
  jsunitRun();
</script>
