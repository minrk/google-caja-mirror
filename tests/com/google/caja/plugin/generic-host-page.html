<!doctype html>
<!--
 - Copyright (C) 2013 Google Inc.
 -
 - Licensed under the Apache License, Version 2.0 (the "License");
 - you may not use this file except in compliance with the License.
 - You may obtain a copy of the License at
 -
 -      http://www.apache.org/licenses/LICENSE-2.0
 -
 - Unless required by applicable law or agreed to in writing, software
 - distributed under the License is distributed on an "AS IS" BASIS,
 - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 - See the License for the specific language governing permissions and
 - limitations under the License.
-->
<!doctype html>
<html><head>
  <meta charset="utf-8">
  <title>Caja generic host page (no test hooks)</title>
  <!-- TODO(kpreid): Allow minified/unminified choice -->
  <script src="/caja/caja.js"></script>
  <script>
    // note - duplicated from browser-test-case.js
    function urlParamPattern(name) {
      name = name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");
      return new RegExp("([\\?&]"+name+"=)([^&#]*)");
    }
    function getUrlParam(name, opt_default) {
      var match = urlParamPattern(name).exec(window.location.href);
      if (match) {
        return decodeURIComponent(match[2].replace(/\+/g, ' '));
      } else {
        return opt_default ? opt_default : '';
      }
    }
  </script>
  <style>
    html {
      background: #CCC;
      color: black;
    }
    #guest {
      background: white;
      color: black;
      border: 0.1em solid black;
    }

    #form [name="content"] {
      margin-left: 0;
      margin-right: 0;
      box-sizing: border-box;
      width: 100%;
      height: 20em;
    }
    #load {
      float: right;
      padding: 1em;
    }
    #guest {
      clear: right;
    }
  </style>
</head><body>
  <div id="toolbar">
    <span class='nonwidget'><a href='test-index.html'>other tests</a></span>
  </div>
  <form id="form" action="" method="GET">
    <label>SES maximum severity<select name="maxAcceptableSeverity">
      <option>SAFE</option>
      <option selected>SAFE_SPEC_VIOLATION</option>
      <option>NO_KNOWN_EXPLOIT_SPEC_VIOLATION</option>
      <option>UNSAFE_SPEC_VIOLATION</option>
      <option>NOT_OCAP_SAFE</option>
      <option>NOT_ISOLATED</option>
      <option>NEW_SYMPTOM</option>
      <option>NOT_SUPPORTED</option>
    </select></label>
    &middot;
    <label>
      <input type="checkbox" name="debug" value="true">
      Config <code>debug</code>
    </label>
    <label>
      <input type="checkbox" name="alert" value="true">
      Provide <code>alert</code>
    </label>
    <br>
    <textarea type="text" name="content"></textarea>
    <button id="load" type="submit">Load</button>
    <script>
      var options = {};
      Array.prototype.forEach.call(document.querySelectorAll(
          '#form [name]'), function(el) {
        if (el.tagName === 'INPUT' && el.type === 'checkbox') {
          el.checked = JSON.parse(getUrlParam(el.name, '' + el.checked));
          options[el.name] = el.checked;
        } else {
          el.value = getUrlParam(el.name, el.value);
          options[el.name] = el.value;
        }
      });
    </script>
  </form>
  <p>Status: <span id="status">&mdash;</span></p>
  <div id="guest"></div>
  <script>
    function status(s) {
      console.info(s);
      document.getElementById('status').textContent = s;
    }

    status('caja.initialize()');
    caja.initialize({
      cajaServer: '/caja',
      debug: options.debug,
      maxAcceptableSeverity: options.maxAcceptableSeverity
    });
    status('caja.load()');
    caja.load(
        document.getElementById('guest'),
        caja.policy.net.ALL,
        function(frame) {
          status('frame.content().run()');
          frame.content('http://caja-host-url.invalid/', options.content);
          if (options.alert) {
            frame.api({
                  alert: frame.tame(frame.markFunction(function(s) {
                    window.alert('Guest alerts: ' + s);
                  }))
                });
          }
          frame.run(function() {
                status('Complete');
              });
        });
  </script>
</body></html>